# 哨兵

### 故障转移

在主从复制模式下，**当主节点因故下线时，将它的一个从节点转换为主节点，并使用新的主节点继续处理命令请求， 这样整个系统就可以继续运转，不必因为主节点的下线而停机。**这样的处理方式称为故障转移，整个操作过程如下： 

1. 主节点发生故障后，应用方连接主节点失败，**从节点与主节点连接失败造成复制中断**； 
2. 选出一个从节点，并对其执行 "replicaof no one" 命令，使其成为**新的主节点**； 
3. **更新应用方的主节点信息**，并重启应用方服务； 
4. **通过客户端，命令其他从节点复制新的主节点**； 
5. 原来的主节点恢复后，让它去**复制新的主节点**。

### 主从复制的问题

◼ 非高可用 

1. 需要手动将一个从节点晋升为主节点； 
2. 需要手动修改应用方的主节点地址并重启服务； 
3. 需要手动命令所有的从节点去复制新的主节点； 

◼ 解决方案

1. 编写程序，将上述流程自动化； 
2. **使用哨兵模式，在主节点下线时自动对其实施故障转移**。

### 哨兵

◼ Redis Sentinel（哨兵）是一个**分布式架构**，它包含若干个**哨兵节点和数据节点**； 

◼ 每个**哨兵节点会对数据节点和其余的哨兵节点进行监控**，当发现节点不可达时，会对节点做下线标识； 

◼ 如果被标识的是主节点，它就会与其他的哨兵节点进行协商，当多数哨兵节点都认为主节点不可达时， 它们便会**选举出一个哨兵节点来完成自动故障转移的工作**，同时还会将这个变化实时地通知给应用方。

###  哨兵的拓扑结构

![](pic\1.png)

### 哨兵节点的特征

1. 哨兵节点会**定期监控数据节点，其他哨兵节点**是否可达； 
2. 哨兵节点**会将故障转移的结果通知给应用方**； 
3. 哨兵节点可以将从节点晋升为主节点，并维护后续正确的主从关系； 
4. 哨兵模式下，**客户端连接的是哨兵节点集合，从中获取主节点信息**； 
5. 节点的故障判断是由多个哨兵节点共同完成的，可有效地防止误判；
6. 哨兵节点集合是由多个哨兵节点组成的，即使个别哨兵节点不可用，整个集合依然是健壮的； 
7. 哨兵节点**也是独立的Redis节点，是特殊的Redis节点，它们不存储数据，只支持部分命令**。