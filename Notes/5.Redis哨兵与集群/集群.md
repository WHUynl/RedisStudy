# 集群

### 数据分布理论(哈希分区)

#### 1. 节点取余分区

使用特定的数据（如键、用户ID等），再根据节点数量计算出哈希值，用来决定数据映射到哪一个节点上， 计算公式：hash(key)%N； 

优点：简单； 

缺点：**当节点数量发生变化（扩容/收缩）时，数据节点映射关系需要重新计算，会导致数据的重新迁移**； 

应用：常用于数据库的分库分表规则，一般采用预分区的方式，提前根据数量规划好分区数，保证可支撑未来 一段时间的数据量。

#### 2.一致性哈希分区

一致性哈希算法中首先有一个哈希函数，哈希函数产生hash值，所有可 能的哈希值构成一个哈希空间，哈希空间为[0, 2^32-1]，这本来是一个 “线性”的空间，但是在算法中通过恰当逻辑控制，使其首尾相衔接，也 即是0=2^32，这样就构造一个逻辑上的环形空间。 

优点：增加或删除节点只影响哈希环中相邻的节点，对其他节点无影响； 

缺点：一致性哈希算法在服务节点太少时，容易因为节点分部不均匀而 造成数据倾斜问题。**比如只有2台机器，这2台机器离的很近，那么顺时 针第一个机器节点上将存在大量的数据，第二个机器节点上数据会很少。**

![](pic\3.png)

#### 3.虚拟槽分区(Redis使用的方法)

虚拟槽分区巧妙地使用了哈希空间，使用分散度良好的哈希函 数把所有数据**映射到一个固定范围的整数集合中**，整数定义为 槽（slot）。槽是**集群内数据管理和迁移的基本单位**，采用 大范围槽的主要目的是为了方便数据拆分和集群扩展，每个节 点会负责一定数量的槽，Redis集群就是采用这种分区方式。

![](pic\4.png)

### Redis数据分区

Redis集群采用虚拟槽分区，**所有的键根据哈希函数映射到0-16383整数槽内**， 计算公式：**slot=CRC16(key)&16383**，每一个节点负责维护一部分槽以及槽所映射的键值数据。虚拟槽分区具有如下特点： 

1. **解耦数据和节点之间的关系**，简化了节点扩容和收缩的难度； 
2. **节点自身维护槽的映射关系**，不需要客户端或者代理服务维护槽分区元数据； 
3. **支持节点、槽、键之间的映射查询，用于数据路由，在线伸缩等场景**。

### 集群功能的限制

1. key批量操作支持有限。如mset、mget，目前**只支持具有相同slot值的key执行批量操作**。对于映射为不同 slot值的key由于执行mset、mget等操作可能存在于多个节点上所以不被支持。 
2. key事务操作支持有限。**同理只支持多key在同一节点上的事务操作**，当多个key分布在不同的节点上时无法使 用事务功能。 
3. key作为数据分区的最小粒度，因此**不能将一个大的键值对象（如hash、list等）映射到不同的节点**。 
4. 不支持多数据库空间。单机下的Redis可以支持16个数据库，集群模式下只能使用一个数据库空间，即DB0。 
5. 复制结构只支持一层，**从节点只能复制主节点，不支持嵌套树状复制结构**。 