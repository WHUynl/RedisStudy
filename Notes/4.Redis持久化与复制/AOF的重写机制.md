# AOF的重写机制

### AOF重写

◼ 随着写入操作的不断进行，AOF文件内会包含越来越多的冗余命令：

1. 已经超时的数据； 
2. 已经删除的数据； 
3. 多次经过修改的数据；

 ◼ 冗余命令不仅增加了AOF文件的体积，也会严重影响恢复数据的速度： 

1. 为了减少冗余命令，从而提高恢复数据的速度，Redis提供了AOF重写功能； 
2. 该功能可以生成一个全新的AOF文件，并让文件只包含恢复当前数据库所需的尽可能少的命令。

### AOF重写的流程

![](pic\8.png)

**注意**

子线程在重写新的AOF文件的过程中，无法感知父进程的Redis新的命令，所以：

1.使用aof_buf存放到来的命令，并正常flush到旧AOF文件中。

2.使用rewrite_buf存放相同的命令，用于加入到新的AOF中。



### 重启加载

![](pic\9.png)