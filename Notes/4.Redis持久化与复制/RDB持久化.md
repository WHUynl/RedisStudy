# RDB持久化

### 简介

1. RDB(Redis Database)是Redis默认采用的持久化方式，它以**快照**的形式将进程数据持久化到硬盘中；  

2. RDB会创建一个经过压缩的**二进制文件**，文件以“.rdb”结尾，内部存储了各个数据库的键值对数据等信息；  

3. RDB持久化的触发方式有两种 

   • 手动触发：通过SAVE(已弃用)或**BGSAVE**命令触发RDB持久化操作，创建“.rdb”文件； 

   • 自动触发：通过配置选项，让服务器在满足指定条件时自动执行BGSAVE命令。

### BGSAVE命令

```bash
127.0.0.1:6379> BGSAVE
```

BGSAVE命令是**异步版本**的SAVE命令，它会使用Redis服务器进程的**子进程**，创建“.rdb”文件；

BGSAVE命令在**创建子进程时会存在短暂的阻塞**，之后服务器便可以继续处理其他客户端的请求；

### 配置选项

```bash
save <seconds> <changes>
```

1. 如果服务器在seconds秒内，对数据库总共执行了changes次修改，则自动执行一次BGSAVE命令；
2. 可以同时配置多个save选项，当给定选项中的任意一个条件满足时，则自动执行一次BGSAVE命令。

**注意**

为了避免同时使用多个触发条件而导致服务器过于频繁地执行BGSAVE命令，Redis 服务器在每次成功创建“.rdb”文件之后，**负责自动触发BGSAVE命令的时间计数器以 及修改次数计数器都会被清零并重新开始计数**，无论这个“.rdb”文件是由**自动触发**的BGSAVE命令创建的，还是由**用户执行的SAVE或BGSAVE命令创建**的，都是如此。

### BGSAVE的流程

![](pic\1.png)

### BGSAVE的原理

![](pic\2.png)

**总结**

使用写时复制，则子进程一直使用原内存中的数据，生成rdb文件；而父进程进行修改的时候，则会定位到修改的页，**先复制页的内容，然后进行修改，并且以后也只使用这个页的数据**，从而保证了读写不冲突。**所以，这里也体现出BGSAVE无法实时持久化。**

### RDB的优缺点

◼ 优点 

RDB生成紧凑压缩的二进制文件，**体积小**，使用该文件**恢复数据的速度非常快**；

 ◼ 缺点 

BGSAVE每次运行都要**执行fork操作创建子进程**，属于重量级操作，不宜频繁执行， 

所以RDB持久化没办法做到实时的持久化。